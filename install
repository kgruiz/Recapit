#!/usr/bin/env bash
set -euo pipefail

if ! command -v cargo >/dev/null 2>&1; then
  echo "error: cargo is required but was not found in PATH." >&2
  echo "Install Rust via https://rustup.rs/ and ensure cargo is available." >&2
  exit 1
fi

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

printf 'Installing recapit from %s\n' "$SCRIPT_DIR"

# Warn when common external tools are missing so users can install them early.
missing_tools=()
for tool in ffmpeg yt-dlp pdftoppm pdfinfo; do
  if ! command -v "$tool" >/dev/null 2>&1; then
    missing_tools+=("$tool")
  fi
done

if ((${#missing_tools[@]} > 0)); then
  printf 'warning: missing external tools: %s\n' "${missing_tools[*]}"
  printf '         recapit can install without them, but runtime features may fail.\n'
fi

cargo install --path "$SCRIPT_DIR" --locked --force "$@"

# Install man page (defaults to ~/.local/share/man unless MANPREFIX is set)
MANPREFIX=${MANPREFIX:-"$HOME/.local/share/man"}
MANDIR="$MANPREFIX/man1"
MANPAGE_SOURCE="$SCRIPT_DIR/man/recapit.1"

if [ -f "$MANPAGE_SOURCE" ]; then
  if mkdir -p "$MANDIR" && cp "$MANPAGE_SOURCE" "$MANDIR/"; then
    printf 'installed man page to %s\n' "$MANDIR"
  else
    printf 'warning: failed to install man page to %s (check permissions)\n' "$MANDIR" >&2
  fi
fi

printf 'recapit installation complete.\n'
